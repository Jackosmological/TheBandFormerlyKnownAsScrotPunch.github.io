<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CRT TV</title>
<link rel="stylesheet" href="styles.css"/>
</head>

<body>

<div class="tv" id="tv">

  <img class="tv-screen" src="screen.png" alt="">

  <!-- Static video layer -->
  <video class="tv-static-video" id="staticVideo" loop playsinline muted preload="auto">
    <source src="static.mp4" type="video/mp4">
  </video>

  <video class="tv-video" id="video" loop playsinline preload="metadata">
    <source src="band.mp4" type="video/mp4">
  </video>

  <button class="play-btn" id="playBtn" aria-label="Play/Pause"></button>

  <img class="tv-frame" src="tv.png" alt="">

  <!-- Red video select buttons (topmost) -->
  <button class="vid-btn" id="v1" data-src="band1.mp4" aria-label="Play band 1">1</button>
  <button class="vid-btn" id="v2" data-src="band2.mp4" aria-label="Play band 2">2</button>
  <button class="vid-btn" id="v3" data-src="band3.mp4" aria-label="Play band 3">3</button>
  <button class="vid-btn" id="v4" data-src="band4.mp4" aria-label="Play band 4">4</button>
  <button class="vid-btn" id="v5" data-src="band5.mp4" aria-label="Play band 5">5</button>

  <button class="vid-btn" id="vDefault" data-src="band.mp4" aria-label="Play default video">DEFAULT</button>

</div>

<audio id="staticAudio" loop preload="auto">
  <source src="static.mp3" type="audio/mpeg">
</audio>

<script>
const tv = document.getElementById("tv");

const video = document.getElementById("video");
const videoSource = video.querySelector("source");

const staticVideo = document.getElementById("staticVideo");

const btn = document.getElementById("playBtn");
const staticAudio = document.getElementById("staticAudio");

let videoMode = false;
let switching = false;

/* Timing */
const DELAY_BEFORE_NEW_VIDEO_MS = 1500;  // keep your 1.5s delay
const QUICK_FADE_MS = 400;              // fade to static (visual/audio) in ~0.4s
const SLOW_CROSSFADE_MS = 2000;         // static out + video in completes in 2s

/* ---------- audio fade helper ---------- */
let fadeRAF = null;
function fadeAudioTo(target, ms){
  cancelAnimationFrame(fadeRAF);
  const startVol = Number.isFinite(staticAudio.volume) ? staticAudio.volume : 0;
  const start = performance.now();

  function tick(t){
    const p = Math.min(1, (t - start) / ms);
    staticAudio.volume = startVol + (target - startVol) * p;
    if(p < 1) fadeRAF = requestAnimationFrame(tick);
  }
  fadeRAF = requestAnimationFrame(tick);
}

/* ---------- guarantee audio starts on first user gesture ---------- */
let audioUnlocked = false;
function unlockAudio(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  // Try to start static audio silently (so later fades work reliably)
  staticAudio.volume = 0;
  staticAudio.play().then(()=> {
    // leave it paused unless we’re showing static, to match your vibe
    staticAudio.pause();
    staticAudio.currentTime = 0;
  }).catch(()=>{});
}
window.addEventListener("pointerdown", unlockAudio, { once:true, passive:true });

/* ---------- static layer controls ---------- */
async function startStaticLayerQuick(){
  tv.classList.add("static-on");
  tv.classList.remove("static-out");

  // start static video (muted -> should autoplay without gesture)
  try{
    await staticVideo.play();
  }catch(e){}

  // start / fade in static audio (gesture usually available on button click)
  if(staticAudio.paused){
    staticAudio.currentTime = 0;
    staticAudio.volume = 0;
    staticAudio.play().catch(()=>{});
  }
  fadeAudioTo(0.6, QUICK_FADE_MS);
}

function fadeOutStaticLayerSlow(){
  tv.classList.add("static-out");
  fadeAudioTo(0, SLOW_CROSSFADE_MS);

  setTimeout(() => {
    tv.classList.remove("static-on");
    tv.classList.remove("static-out");
    staticVideo.pause();
    staticVideo.currentTime = 0;

    if(staticAudio.volume <= 0.02){
      staticAudio.pause();
      staticAudio.currentTime = 0;
    }
  }, SLOW_CROSSFADE_MS + 50);
}

/* ---------- core switch logic ---------- */
async function switchToVideo(src){
  if(switching) return;
  switching = true;

  // Ensure we’re in video mode
  if(!videoMode){
    videoMode = true;
    tv.classList.add("video-on");
  }

  // 1) Fade current video out + bring static in (visual/audio)
  tv.classList.add("video-fadeout");
  await startStaticLayerQuick();

  // 2) Wait 1.5s before starting the new clip
  setTimeout(async () => {
    const current = videoSource.getAttribute("src") || "";
    if(current !== src){
      video.pause();
      videoSource.setAttribute("src", src);
      video.load();
    }

    try{ await video.play(); }catch(e){}

    // 3) Begin slow crossfade: static out (2s) while video fades in (2s)
    tv.classList.remove("video-fadeout");
    fadeOutStaticLayerSlow();

    // unlock after crossfade
    setTimeout(() => {
      switching = false;
    }, SLOW_CROSSFADE_MS + 80);

  }, DELAY_BEFORE_NEW_VIDEO_MS);
}

/* ---------- play button behavior ---------- */
btn.onclick = async ()=>{
  if(!videoMode){
    await switchToVideo(videoSource.getAttribute("src") || "band.mp4");
    return;
  }

  // toggle pause/play (no static transition here)
  if(video.paused){
    try{ await video.play(); }catch(e){}
  }else{
    video.pause();
  }
};

/* ---------- red buttons switch clips with static transition ---------- */
document.querySelectorAll(".vid-btn").forEach(b => {
  b.addEventListener("click", async (e) => {
    e.stopPropagation();
    const src = b.dataset.src;
    if(src) await switchToVideo(src);
  });
});
</script>

</body>
</html>
