<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CRT TV</title>
<link rel="stylesheet" href="styles.css"/>
</head>

<body>

<div class="tv" id="tv">

  <img class="tv-screen" src="screen.png" alt="">

  <!-- NEW: Static video layer -->
  <video class="tv-static-video" id="staticVideo" loop playsinline muted preload="metadata">
    <source src="static.mp4" type="video/mp4">
  </video>

  <video class="tv-video" id="video" loop playsinline preload="metadata">
    <source src="band.mp4" type="video/mp4">
  </video>

  <button class="play-btn" id="playBtn" aria-label="Play/Pause"></button>

  <img class="tv-frame" src="tv.png" alt="">

  <!-- Red video select buttons (topmost) -->
  <button class="vid-btn" id="v1" data-src="band1.mp4" aria-label="Play band 1">1</button>
  <button class="vid-btn" id="v2" data-src="band2.mp4" aria-label="Play band 2">2</button>
  <button class="vid-btn" id="v3" data-src="band3.mp4" aria-label="Play band 3">3</button>
  <button class="vid-btn" id="v4" data-src="band4.mp4" aria-label="Play band 4">4</button>
  <button class="vid-btn" id="v5" data-src="band5.mp4" aria-label="Play band 5">5</button>

  <button class="vid-btn" id="vDefault" data-src="band.mp4" aria-label="Play default video">DEFAULT</button>

</div>

<audio id="staticAudio" loop preload="auto">
  <source src="static.mp3" type="audio/mpeg">
</audio>

<script>
const tv = document.getElementById("tv");

const video = document.getElementById("video");
const videoSource = video.querySelector("source");

const staticVideo = document.getElementById("staticVideo");
const staticVideoSource = staticVideo.querySelector("source");

const btn = document.getElementById("playBtn");
const staticAudio = document.getElementById("staticAudio");

let videoMode = false;
let switching = false;

/* ---------- audio fade helper ---------- */
let fadeRAF = null;
function fadeAudioTo(target, ms=300){
  cancelAnimationFrame(fadeRAF);
  const startVol = Number.isFinite(staticAudio.volume) ? staticAudio.volume : 0;
  const start = performance.now();

  function tick(t){
    const p = Math.min(1, (t - start) / ms);
    staticAudio.volume = startVol + (target - startVol) * p;
    if(p < 1) fadeRAF = requestAnimationFrame(tick);
  }
  fadeRAF = requestAnimationFrame(tick);
}

/* ---------- static layer controls ---------- */
function startStaticLayerQuick(){
  tv.classList.add("static-on");
  tv.classList.remove("static-out");

  // start static video
  try{ staticVideo.play(); }catch(e){}

  // start / fade in static audio (may be blocked until user gesture)
  if(staticAudio.paused){
    staticAudio.volume = 0;
    staticAudio.play().catch(()=>{});
  }
  fadeAudioTo(0.6, 180);
}

function fadeOutStaticLayerSlow(){
  tv.classList.add("static-out");
  // fade audio down slowly too
  fadeAudioTo(0, 1600);

  // after fade finishes, fully stop the layer + clean classes
  setTimeout(() => {
    tv.classList.remove("static-on");
    tv.classList.remove("static-out");
    staticVideo.pause();
    staticVideo.currentTime = 0;

    // pause audio if effectively silent
    if(staticAudio.volume <= 0.02){
      staticAudio.pause();
      staticAudio.currentTime = 0;
    }
  }, 1700);
}

/* ---------- initial: show static immediately ---------- */
tv.classList.add("static-on");
window.addEventListener("load", () => {
  // Try to start static video + audio (audio may be blocked)
  try{ staticVideo.play(); }catch(e){}
  staticAudio.volume = 0.6;
  staticAudio.play().catch(()=>{});
});

/* ---------- core switch logic ---------- */
async function switchToVideo(src){
  if(switching) return;
  switching = true;

  // Ensure weâ€™re in "video mode" (same transition you had)
  if(!videoMode){
    videoMode = true;
    tv.classList.add("video-on");
  }

  // 1) QUICK: fade out current video + fade in static
  tv.classList.add("video-fadeout");     // quick fade to black
  startStaticLayerQuick();              // quick static in

  // 2) Wait 1.5s before starting the new clip
  setTimeout(async () => {
    // Set new source if needed
    const current = videoSource.getAttribute("src") || "";
    if(current !== src){
      video.pause();
      videoSource.setAttribute("src", src);
      video.load();
    }

    // Start playing (may require user gesture; buttons count as a gesture)
    try{ await video.play(); }catch(e){}

    // 3) Start the slow crossfade: static out, video in
    tv.classList.remove("video-fadeout");  // video returns to opacity 1 via CSS slow transition
    fadeOutStaticLayerSlow();

    // Allow a bit of time for the crossfade to finish before unlocking
    setTimeout(() => {
      switching = false;
    }, 1700);
  }, 1500);
}

/* ---------- play button behavior (kept, but now uses the same switch logic on first click) ---------- */
btn.onclick = async ()=>{
  if(!videoMode){
    // First click: behave like starting the default video through the same pipeline
    await switchToVideo(videoSource.getAttribute("src") || "band.mp4");
    return;
  }

  // toggle pause/play (no static transition here, per your original behavior)
  if(video.paused){
    try{ await video.play(); }catch(e){}
  }else{
    video.pause();
  }
};

/* ---------- red buttons switch clips with static transition ---------- */
document.querySelectorAll(".vid-btn").forEach(b => {
  b.addEventListener("click", async (e) => {
    e.stopPropagation();
    const src = b.dataset.src;
    if(src) await switchToVideo(src);
  });
});
</script>

</body>
</html>
